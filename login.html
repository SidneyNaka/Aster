<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login - Aster</title>
    
    <link rel="icon" href="img/aster_transparent.png" type="image/png" />
    
    <link rel="stylesheet" href="login.css" />
</head>
<body>
    
    <main>
        <div class="container">
            
            <div class="sidebar-area">
                <div class="logo-in-card">
                    <img src="img/simbolo_nome.png" />
                    <h1>ASTER</h1>
                </div>
            </div> 

            <section class="login-section">
                <div id="login-form" class="form active">
                    <h2 class="login-title">Entrar no Aster</h2>
                    <p class="login-subtitle">Acesse sua conta e descubra novas músicas</p>

                    <form>
                        <label for="user">E-mail ou telefone</label>
                        <input type="text" id="user" name="user" placeholder="Digite seu e-mail ou telefone" required />

                        <label for="password">Senha</label>
                        <input type="password" id="password" name="password" placeholder="Digite sua senha" required />

                        <button type="submit" class="btn-login">Entrar</button>

                        <p id="error-message" class="error-text"></p>
                    </form>
                    <div class="options">
                        <a href="#" id="forgot-password-link" class="forgot-password">Esqueceu sua senha?</a>
                        <a href="#" id="create-account-link" class="create-account">Criar uma nova conta</a>
                    </div>
                </div>

                <div id="forgot-password-form" class="form">
                    <h2 class="login-title">Recuperar Senha</h2>
                    <form>
                        <label for="recover-email">E-mail ou telefone</label>
                        <input type="text" id="recover-email" name="recover-email" placeholder="Digite seu e-mail ou telefone" required />
                        <button type="submit" class="btn-login">Enviar link de recuperação</button>
                    </form>
                    <div class="options">
                        <a href="#" id="back-to-login-from-forgot">Voltar ao login</a>
                    </div>
                </div>

                <div id="create-account-form" class="form">
                    <h2 class="login-title">Criar Nova Conta</h2>
                    <form>
                        <label for="new-username">Nome de Usuário</label>
                        <input type="text" id="new-username" name="new-username" placeholder="Digite seu nome de usuário" required />

                        <label for="new-user">E-mail ou telefone</label>
                        <input type="text" id="new-user" name="new-user" placeholder="Digite seu e-mail ou telefone" required />

                        <label for="new-password">Senha</label>
                        <div class="password-input-group">
                            <input type="password" id="new-password" name="new-password" placeholder="Digite sua senha" required />
                            <img src="img/eye-open.png" class="password-toggle-icon" alt="Mostrar/Ocultar Senha">
                        </div>

                        <label for="confirm-password">Confirmar Senha</label>
                        <div class="password-input-group">
                            <input type="password" id="confirm-password" name="confirm-password" placeholder="Confirme sua senha" required />
                            <img src="img/eye-open.png" class="password-toggle-icon" alt="Mostrar/Ocultar Senha">
                        </div>

                        <div class="password-requirements">
                            <ul id="password-criteria-list-register">
                                <li id="length-check-register">Pelo menos 8 caracteres</li>
                                <li id="lowercase-check-register">Uma letra minúscula (a-z)</li>
                                <li id="uppercase-check-register">Uma letra maiúscula (A-Z)</li>
                                <li id="number-check-register">Um número (0-9)</li>
                                <li id="special-check-register">Um caractere especial (!@#$)</li>
                            </ul>
                        </div>

                        <button type="submit" class="btn-login">Criar conta</button>
                    </form>
                    <div class="options">
                        <a href="#" id="back-to-login-from-create">Voltar ao login</a>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer>
        <p><span class="footer-highlight">Aster:</span> onde a música vira emoção e acompanha seus momentos.</p>
    </footer>

    <script>
    // --- Seleção dos Elementos ---
    const loginForm = document.getElementById('login-form');
    const forgotForm = document.getElementById('forgot-password-form');
    const createForm = document.getElementById('create-account-form');
    const forgotLink = document.getElementById('forgot-password-link');
    const createLink = document.getElementById('create-account-link');
    const backFromForgot = document.getElementById('back-to-login-from-forgot');
    const backFromCreate = document.getElementById('back-to-login-from-create');
    const loginFormEl = loginForm.querySelector('form');
    const createFormEl = createForm.querySelector('form');
    const errorMessageEl = document.getElementById('error-message');
    const loginEmailInput = document.getElementById('user');
    const createEmailInput = document.getElementById('new-user');

    // --- Função para Alternar Formulários ---
    function showForm(formToShow) {
        loginForm.classList.remove('active');
        forgotForm.classList.remove('active');
        createForm.classList.remove('active');
        formToShow.classList.add('active');
    }

    // --- Eventos dos Links de Navegação ---
    createLink.addEventListener('click', (e) => { e.preventDefault(); showForm(createForm); });
    forgotLink.addEventListener('click', (e) => { e.preventDefault(); showForm(forgotForm); });
    backFromForgot.addEventListener('click', (e) => { e.preventDefault(); showForm(loginForm); });
    backFromCreate.addEventListener('click', (e) => { e.preventDefault(); showForm(loginForm); });

    // --- LÓGICA DE VALIDAÇÃO DE E-MAIL ---
    const validateEmail = (input) => {
        if (!input) return;
        input.addEventListener('input', () => {
            const emailValue = input.value;
            if (emailValue.length > 0) {
                const isValid = emailValue.includes('@');
                input.classList.toggle('valid', isValid);
                input.classList.toggle('invalid', !isValid);
            } else {
                input.classList.remove('valid', 'invalid');
            }
        });
    };
    validateEmail(loginEmailInput);
    validateEmail(createEmailInput);

    // --- Lógica do Formulário de Login ---
    loginFormEl.addEventListener('submit', function(e) {
        e.preventDefault();
        if(errorMessageEl) errorMessageEl.style.display = 'none';
        const email = loginEmailInput.value;
        const senha = document.getElementById('password').value;
        if (!email.includes('@')) {
            errorMessageEl.textContent = 'Por favor, insira um e-mail válido.';
            errorMessageEl.style.display = 'block';
            return;
        }
        fetch('http://localhost:3000/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email, password: senha })
        }).then(response => response.json()).then(data => {
            if (data.success) {
                localStorage.setItem('token', data.token);
                window.location.href = 'home.html';
            } else {
                if(errorMessageEl) { errorMessageEl.textContent = data.message; errorMessageEl.style.display = 'block'; }
            }
        }).catch(error => {
            if(errorMessageEl) { errorMessageEl.textContent = 'Não foi possível conectar ao servidor.'; errorMessageEl.style.display = 'block'; }
        });
    });

    // --- NOVA LÓGICA: VALIDAÇÃO DE SENHA NO CADASTRO ---
    const newPasswordInput = document.getElementById('new-password');
    const criteriaList = {
        length: document.getElementById('length-check-register'),
        lowercase: document.getElementById('lowercase-check-register'),
        uppercase: document.getElementById('uppercase-check-register'),
        number: document.getElementById('number-check-register'),
        special: document.getElementById('special-check-register')
    };

    if (newPasswordInput) {
        newPasswordInput.addEventListener('input', () => {
            const password = newPasswordInput.value;
            criteriaList.length.classList.toggle('valid', password.length >= 8);
            criteriaList.lowercase.classList.toggle('valid', /[a-z]/.test(password));
            criteriaList.uppercase.classList.toggle('valid', /[A-Z]/.test(password));
            criteriaList.number.classList.toggle('valid', /[0-9]/.test(password));
            criteriaList.special.classList.toggle('valid', /[!@#$%^&*(),.?":{}|<>]/.test(password));
        });
    }

    // --- Lógica do Formulário de Criação de Conta ---
    createFormEl.addEventListener('submit', function(e) {
        e.preventDefault();

        // ADICIONADO: Bloqueia o envio se a senha for inválida
        const allCriteriaValid = Object.values(criteriaList).every(item => item.classList.contains('valid'));
        if (!allCriteriaValid) {
            alert('Sua senha não atende a todos os requisitos de segurança.');
            return;
        }
        
        const username = document.getElementById('new-username').value;
        const email = createEmailInput.value;
        const password = newPasswordInput.value;
        const confirmPassword = document.getElementById('confirm-password').value;

        if (!email.includes('@')) {
            alert("Por favor, insira um endereço de e-mail válido.");
            return;
        }

        if (password !== confirmPassword) {
            alert("As senhas não coincidem!");
            return;
        }

        fetch('http://localhost:3000/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, email, password })
        }).then(res => res.json()).then(data => {
            alert(data.message);
            if (data.success) {
                showForm(loginForm);
                createFormEl.reset();
                createEmailInput.classList.remove('valid', 'invalid');
                Object.values(criteriaList).forEach(item => item.classList.remove('valid'));
            }
        }).catch(err => {
            console.error('Erro na requisição de registro:', err);
            alert('Ocorreu um erro ao tentar criar a conta.');
        });
    });

    // --- NOVA LÓGICA: MOSTRAR/OCULTAR SENHA PARA TODOS OS CAMPOS ---
    const passwordToggleIcons = document.querySelectorAll('.password-toggle-icon');
    passwordToggleIcons.forEach(icon => {
        icon.addEventListener('click', () => {
            const passwordInput = icon.previousElementSibling;
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.src = 'img/eye-closed.png';
            } else {
                passwordInput.type = 'password';
                icon.src = 'img/eye-open.png';
            }
        });
    });
    </script>
</body>
</html>
